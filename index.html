import React, { useState, useEffect, createContext, useContext } from 'react';
import { 
  Heart, Activity, Thermometer, MapPin, Bell, Shield, 
  Users, FileText, LogOut, Menu, X, AlertTriangle, 
  CheckCircle, Search, Settings, ChevronRight, User, Home, 
  Sparkles, MessageSquare, Mic, Cpu, DollarSign, Info, Layers, LayoutDashboard
} from 'lucide-react';

// --- Types ---
type UserRole = 'patient' | 'caregiver' | 'doctor' | 'admin' | 'guest' | null;

interface User {
  uid: string;
  name: string;
  role: UserRole;
  email: string;
}

// --- Contexts ---
const AuthContext = createContext<{
  user: User | null;
  login: (role: UserRole) => void;
  logout: () => void;
  apiKey: string;
  setApiKey: (key: string) => void;
}>({ user: null, login: () => {}, logout: () => {}, apiKey: '', setApiKey: () => {} });

// --- Helper: Gemini API Call ---
const callGemini = async (prompt: string, apiKey: string) => {
  if (!apiKey) return null;
  
  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      }
    );
    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text;
  } catch (error) {
    console.error("Gemini API Error:", error);
    return null;
  }
};

// --- UI Components ---

const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false }: any) => {
  const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed";
  const variants = {
    primary: "bg-teal-600 text-white hover:bg-teal-700 shadow-md",
    secondary: "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50",
    danger: "bg-red-600 text-white hover:bg-red-700 shadow-md animate-pulse",
    ghost: "text-slate-600 hover:bg-slate-100",
    ai: "bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg hover:shadow-xl border border-transparent"
  };
  return (
    <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant as keyof typeof variants]} ${className}`}>
      {children}
    </button>
  );
};

const Card = ({ title, children, className = '' }: any) => (
  <div className={`bg-white p-6 rounded-xl shadow-sm border border-slate-100 ${className}`}>
    {title && <h3 className="text-lg font-bold text-slate-800 mb-4">{title}</h3>}
    {children}
  </div>
);

const Badge = ({ status }: { status: string }) => {
  const colors = {
    normal: "bg-green-100 text-green-700",
    warning: "bg-yellow-100 text-yellow-700",
    critical: "bg-red-100 text-red-700",
    active: "bg-blue-100 text-blue-700"
  };
  return (
    <span className={`px-2 py-1 rounded-full text-xs font-bold uppercase tracking-wider ${colors[status as keyof typeof colors] || "bg-slate-100"}`}>
      {status}
    </span>
  );
};

// --- SCREENS ---

// 1. Login Screen
const LoginScreen = () => {
  const { login } = useContext(AuthContext);

  return (
    <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4 font-sans">
      <div className="bg-white max-w-5xl w-full rounded-2xl shadow-2xl border border-slate-100 overflow-hidden flex flex-col md:flex-row h-auto md:h-[600px]">
        
        {/* Left Side: Brand & Info */}
        <div className="md:w-1/2 bg-teal-800 text-white p-12 flex flex-col justify-center relative overflow-hidden">
          <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/circuit-board.png')] opacity-10"></div>
          <div className="relative z-10">
            <div className="w-20 h-20 bg-white/10 rounded-3xl flex items-center justify-center mb-8 backdrop-blur-sm border border-white/20 shadow-2xl">
              <Activity className="text-white" size={40} />
            </div>
            <h1 className="text-5xl font-extrabold mb-4 tracking-tight">Rafeeq</h1>
            <p className="text-teal-200 text-xl mb-12 font-light">Autonomous Smart Wheelchair Kit</p>
            
            <div className="space-y-6">
              <div className="flex items-center gap-4">
                <div className="p-3 bg-white/10 rounded-xl"><Cpu size={24}/></div>
                <div><p className="font-bold text-lg">Edge AI Powered</p><p className="text-sm text-teal-200/80">Offline Arabic Voice Control</p></div>
              </div>
              <div className="flex items-center gap-4">
                <div className="p-3 bg-white/10 rounded-xl"><Heart size={24}/></div>
                <div><p className="font-bold text-lg">Health Guardian</p><p className="text-sm text-teal-200/80">Real-time Vitals & Fall Detection</p></div>
              </div>
            </div>
          </div>
        </div>

        {/* Right Side: Login Options */}
        <div className="md:w-1/2 p-12 bg-slate-50 flex flex-col justify-center">
          <h2 className="text-3xl font-bold text-slate-800 mb-2">Welcome Back</h2>
          <p className="text-slate-500 mb-10">Choose your portal to access the demo.</p>
          
          <div className="space-y-4">
            <button 
              onClick={() => login('guest')} 
              className="w-full flex items-center p-4 rounded-xl bg-teal-600 text-white shadow-lg hover:bg-teal-700 hover:scale-[1.02] transition-all group"
            >
              <div className="p-2 bg-white/20 rounded-full mr-4">
                <Info size={24} />
              </div>
              <div className="text-left flex-1">
                <h3 className="font-bold text-lg">Project Overview</h3>
                <p className="text-xs text-teal-100">About, Hardware, Team & Specs</p>
              </div>
              <ChevronRight className="text-white/70 group-hover:text-white" />
            </button>

            <div className="grid grid-cols-2 gap-4">
              <button 
                onClick={() => login('patient')} 
                className="flex flex-col items-center p-6 rounded-xl bg-white border border-slate-200 hover:border-blue-500 hover:shadow-md transition-all group"
              >
                <User size={32} className="text-blue-500 mb-2 group-hover:scale-110 transition-transform"/>
                <span className="font-bold text-slate-700">Patient</span>
              </button>
              
              <button 
                onClick={() => login('caregiver')} 
                className="flex flex-col items-center p-6 rounded-xl bg-white border border-slate-200 hover:border-green-500 hover:shadow-md transition-all group"
              >
                <Heart size={32} className="text-green-500 mb-2 group-hover:scale-110 transition-transform"/>
                <span className="font-bold text-slate-700">Caregiver</span>
              </button>

              <button 
                onClick={() => login('doctor')} 
                className="flex flex-col items-center p-6 rounded-xl bg-white border border-slate-200 hover:border-purple-500 hover:shadow-md transition-all group"
              >
                <FileText size={32} className="text-purple-500 mb-2 group-hover:scale-110 transition-transform"/>
                <span className="font-bold text-slate-700">Doctor</span>
              </button>

              <button 
                onClick={() => login('admin')} 
                className="flex flex-col items-center p-6 rounded-xl bg-white border border-slate-200 hover:border-slate-500 hover:shadow-md transition-all group"
              >
                <Shield size={32} className="text-slate-500 mb-2 group-hover:scale-110 transition-transform"/>
                <span className="font-bold text-slate-700">Admin</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// 2. Dashboard Layout
const DashboardLayout = ({ children, role }: { children: React.ReactNode, role: UserRole }) => {
  const { logout, user, apiKey, setApiKey } = useContext(AuthContext);
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [showSettings, setShowSettings] = useState(false);

  // Define navigation based on role
  const getNavItems = () => {
    const common = [];
    if (role === 'guest') return [
      { icon: Info, label: 'Overview', id: 'overview' },
      { icon: Cpu, label: 'Hardware', id: 'hardware' },
      { icon: DollarSign, label: 'Pricing', id: 'pricing' },
      { icon: Users, label: 'Team', id: 'team' },
    ];
    if (role === 'patient') return [
      { icon: Home, label: 'My Health', id: 'home' },
      { icon: AlertTriangle, label: 'Emergency', id: 'sos' },
      { icon: Mic, label: 'Voice Control', id: 'voice' },
    ];
    if (role === 'caregiver') return [
      { icon: Users, label: 'Patient View', id: 'patients' },
      { icon: MapPin, label: 'Live Map', id: 'map' },
      { icon: Bell, label: 'Alerts', id: 'alerts' },
    ];
    // Default fallback
    return [{ icon: LayoutDashboard, label: 'Dashboard', id: 'home' }];
  };

  return (
    <div className="min-h-screen bg-slate-50 flex font-sans text-slate-900">
      {/* Sidebar */}
      <aside className={`bg-slate-900 text-white transition-all duration-300 ${sidebarOpen ? 'w-64' : 'w-20'} flex flex-col fixed h-full z-20 shadow-2xl`}>
        <div className="p-6 flex items-center justify-between border-b border-slate-800">
          {sidebarOpen && <span className="font-bold text-xl tracking-wider text-teal-400">Rafeeq</span>}
          <button onClick={() => setSidebarOpen(!sidebarOpen)} className="p-2 hover:bg-slate-800 rounded-lg transition-colors">
            {sidebarOpen ? <X size={20} /> : <Menu size={20} />}
          </button>
        </div>
        
        <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
          {getNavItems().map((item) => (
            <button key={item.id} className="w-full flex items-center gap-4 p-3 rounded-xl hover:bg-slate-800 text-slate-300 hover:text-white transition-all group">
              <item.icon size={22} className="group-hover:text-teal-400" />
              {sidebarOpen && <span className="font-medium">{item.label}</span>}
            </button>
          ))}
        </nav>

        <div className="p-4 border-t border-slate-800 space-y-3">
           {role !== 'guest' && (
             <button onClick={() => setShowSettings(!showSettings)} className="w-full flex items-center gap-3 p-3 text-slate-400 hover:bg-slate-800 rounded-xl transition-colors">
              <Settings size={20} />
              {sidebarOpen && <span>Config</span>}
            </button>
           )}

          <div className="flex items-center gap-3 p-2 bg-slate-800/50 rounded-xl">
            <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white shadow-lg ${role === 'guest' ? 'bg-orange-500' : 'bg-teal-600'}`}>
              {user?.name.charAt(0)}
            </div>
            {sidebarOpen && (
              <div className="overflow-hidden">
                <p className="text-sm font-medium truncate text-white">{user?.name}</p>
                <p className="text-xs text-slate-400 capitalize">{user?.role}</p>
              </div>
            )}
          </div>
          <button onClick={logout} className="w-full flex items-center gap-3 p-3 text-red-400 hover:bg-red-900/20 rounded-xl transition-colors">
            <LogOut size={20} />
            {sidebarOpen && <span>Exit Demo</span>}
          </button>
        </div>
      </aside>

      {/* Main Content */}
      <main className={`flex-1 transition-all duration-300 ${sidebarOpen ? 'ml-64' : 'ml-20'} p-8`}>
        {showSettings && (
          <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-xl mb-8 animate-in slide-in-from-top-5">
            <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2 text-lg"><Sparkles size={20} className="text-purple-600"/> AI Configuration</h3>
            <p className="text-sm text-slate-500 mb-4">Enter your Gemini API Key to enable real-time AI features for Voice and Health Analysis.</p>
            <input 
              type="password" 
              value={apiKey}
              onChange={(e) => setApiKey(e.target.value)}
              placeholder="Paste Gemini API Key here..."
              className="w-full p-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-purple-500 outline-none"
            />
          </div>
        )}
        {children}
      </main>
    </div>
  );
};

// 3. Project Info Dashboard (The ALL-IN-ONE Info Hub)
const ProjectInfoDashboard = () => {
  const [activeTab, setActiveTab] = useState<'overview' | 'hardware' | 'pricing' | 'team'>('overview');

  const TabButton = ({ id, label, icon: Icon }: any) => (
    <button 
      onClick={() => setActiveTab(id)}
      className={`flex items-center gap-2 px-6 py-3 rounded-full font-medium transition-all ${
        activeTab === id 
        ? 'bg-teal-600 text-white shadow-lg scale-105' 
        : 'bg-white text-slate-600 hover:bg-slate-100 border border-slate-200'
      }`}
    >
      <Icon size={18} /> {label}
    </button>
  );

  return (
    <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
      
      {/* Header */}
      <div className="bg-gradient-to-r from-teal-800 to-teal-600 rounded-3xl p-10 text-white relative overflow-hidden shadow-2xl">
        <div className="absolute top-0 right-0 p-8 opacity-10"><Cpu size={200} /></div>
        <h1 className="text-4xl font-extrabold mb-4">Project Rafeeq Overview</h1>
        <p className="text-teal-100 max-w-2xl text-lg">A modular, AI-powered retrofit kit transforming standard wheelchairs into autonomous companions.</p>
        
        {/* Navigation Tabs */}
        <div className="flex flex-wrap gap-4 mt-8 relative z-10">
          <TabButton id="overview" label="Overview" icon={Layers} />
          <TabButton id="hardware" label="Hardware" icon={Cpu} />
          <TabButton id="pricing" label="Economics" icon={DollarSign} />
          <TabButton id="team" label="Team" icon={Users} />
        </div>
      </div>

      {/* Content Area */}
      <div className="min-h-[400px]">
        {activeTab === 'overview' && (
          <div className="grid md:grid-cols-2 gap-8 animate-in fade-in">
            <Card title="The Problem" className="border-l-4 border-l-red-500">
              <div className="flex gap-4">
                <div className="bg-red-100 p-4 rounded-xl h-fit text-red-600"><AlertTriangle size={32} /></div>
                <div>
                  <p className="text-slate-600 text-lg leading-relaxed mb-4">Smart wheelchairs are prohibitively expensive, costing over <strong className="text-red-600">$10,000</strong>. This makes them inaccessible to 99% of the Egyptian market, leaving millions with limited independence.</p>
                  <div className="bg-red-50 p-3 rounded-lg text-sm text-red-800 font-bold border border-red-100 inline-block">
                    Gap: High Import Cost vs. Local Need
                  </div>
                </div>
              </div>
            </Card>
            <Card title="The Solution" className="border-l-4 border-l-teal-500">
              <div className="flex gap-4">
                <div className="bg-teal-100 p-4 rounded-xl h-fit text-teal-600"><CheckCircle size={32} /></div>
                <div>
                  <p className="text-slate-600 text-lg leading-relaxed mb-4">We don't build new chairs; we make existing ones smart. Our <strong>Retrofit Modular Kit</strong> installs in 30 minutes, adding autonomy and AI for a fraction of the cost.</p>
                  <div className="flex gap-2 flex-wrap">
                    <Badge status="active"><span className="text-sm">Modular</span></Badge>
                    <Badge status="active"><span className="text-sm">Edge AI</span></Badge>
                    <Badge status="active"><span className="text-sm">~35k EGP</span></Badge>
                  </div>
                </div>
              </div>
            </Card>
            <Card title="Core Features" className="md:col-span-2 bg-slate-50">
              <div className="grid md:grid-cols-3 gap-6">
                <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                  <div className="text-teal-600 mb-3"><Mic size={28}/></div>
                  <h4 className="font-bold text-slate-800 mb-2">Arabic Voice Control</h4>
                  <p className="text-sm text-slate-500">Offline Edge AI processing of Egyptian dialect commands. Private & fast.</p>
                </div>
                <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                  <div className="text-blue-600 mb-3"><MapPin size={28}/></div>
                  <h4 className="font-bold text-slate-800 mb-2">Autonomous Nav</h4>
                  <p className="text-sm text-slate-500">LiDAR & Camera fusion (SLAM) for mapping and obstacle avoidance.</p>
                </div>
                <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                  <div className="text-red-600 mb-3"><Heart size={28}/></div>
                  <h4 className="font-bold text-slate-800 mb-2">Health & Safety</h4>
                  <p className="text-sm text-slate-500">Real-time vitals tracking and instant Fall Detection alerts.</p>
                </div>
              </div>
            </Card>
          </div>
        )}

        {activeTab === 'hardware' && (
          <div className="grid md:grid-cols-2 gap-8 animate-in fade-in">
            <Card title="System Specs">
              <ul className="space-y-6">
                <li className="flex items-start">
                  <div className="bg-purple-100 p-3 rounded-lg mr-4 text-purple-600"><Cpu size={24} /></div>
                  <div>
                    <h4 className="font-bold text-lg text-slate-800">Compute Unit</h4>
                    <p className="text-slate-600">Raspberry Pi 5 (8GB RAM)</p>
                    <p className="text-xs text-slate-400">Running ROS 2 Humble + Ubuntu Server</p>
                  </div>
                </li>
                <li className="flex items-start">
                  <div className="bg-blue-100 p-3 rounded-lg mr-4 text-blue-600"><Activity size={24} /></div>
                  <div>
                    <h4 className="font-bold text-lg text-slate-800">Sensors</h4>
                    <p className="text-slate-600">RPLIDAR A1 (SLAM) + RGB-D Cam</p>
                    <p className="text-xs text-slate-400">IMU (Fall Detect) + Mic Array</p>
                  </div>
                </li>
                <li className="flex items-start">
                  <div className="bg-orange-100 p-3 rounded-lg mr-4 text-orange-600"><Settings size={24} /></div>
                  <div>
                    <h4 className="font-bold text-lg text-slate-800">Actuation</h4>
                    <p className="text-slate-600">Dual 24V DC Motors (High Torque)</p>
                    <p className="text-xs text-slate-400">Closed-Loop PID Control</p>
                  </div>
                </li>
              </ul>
            </Card>
            <div className="space-y-6">
              <div className="bg-slate-900 text-white p-8 rounded-2xl shadow-lg flex flex-col items-center justify-center text-center h-64 border-4 border-slate-800">
                <Layers size={64} className="text-teal-400 mb-4 opacity-80" />
                <h3 className="text-xl font-bold">Mechanical Design</h3>
                <p className="text-slate-400 mt-2 max-w-xs">Universal Clamping Mechanism fits 90% of manual wheelchairs (40-55cm width).</p>
              </div>
              <div className="bg-green-50 p-6 rounded-2xl border border-green-100">
                <h4 className="font-bold text-green-800 flex items-center gap-2"><CheckCircle size={18}/> Battery Life</h4>
                <p className="text-green-700 mt-2">24V 20Ah Lithium-ion pack provides <strong>6-8 hours</strong> of continuous autonomous operation.</p>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'pricing' && (
          <div className="animate-in fade-in">
            <Card title="Market Comparison">
              <div className="overflow-hidden rounded-xl border border-slate-200">
                <table className="w-full text-left border-collapse">
                  <thead className="bg-slate-50">
                    <tr>
                      <th className="p-5 text-slate-500 font-bold uppercase text-xs tracking-wider">Solution Type</th>
                      <th className="p-5 text-slate-500 font-bold uppercase text-xs tracking-wider">Estimated Cost</th>
                      <th className="p-5 text-slate-500 font-bold uppercase text-xs tracking-wider">Availability</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    <tr className="hover:bg-slate-50 transition-colors">
                      <td className="p-5 font-medium text-slate-700">Imported Smart Chair</td>
                      <td className="p-5 text-red-600 font-bold text-lg">$12,000+</td>
                      <td className="p-5 text-slate-500">Scarce / Import Only</td>
                    </tr>
                    <tr className="hover:bg-slate-50 transition-colors">
                      <td className="p-5 font-medium text-slate-700">Standard Electric Chair</td>
                      <td className="p-5 text-slate-800 font-bold">$2,000</td>
                      <td className="p-5 text-slate-500">Available</td>
                    </tr>
                    <tr className="bg-teal-50/50 hover:bg-teal-50 transition-colors">
                      <td className="p-5 font-bold text-teal-800 flex items-center gap-3">
                        <div className="bg-teal-600 text-white p-1 rounded"><CheckCircle size={14}/></div> Rafeeq Modular Kit
                      </td>
                      <td className="p-5 text-teal-700 font-bold text-xl">~ $700 (35k EGP)</td>
                      <td className="p-5 text-teal-700 font-bold">Local Manufacturing</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="bg-gray-50 p-4 rounded-lg text-center">
                  <h4 className="font-bold text-slate-700 text-lg">80%</h4>
                  <p className="text-xs text-slate-500 uppercase">Cost Savings</p>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg text-center">
                  <h4 className="font-bold text-slate-700 text-lg">Local</h4>
                  <p className="text-xs text-slate-500 uppercase">Maintenance</p>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg text-center">
                  <h4 className="font-bold text-slate-700 text-lg">Scalable</h4>
                  <p className="text-xs text-slate-500 uppercase">Manufacturing</p>
                </div>
              </div>
            </Card>
          </div>
        )}

        {activeTab === 'team' && (
          <div className="animate-in fade-in">
            <Card title="The Builders (Zewail City Engineers)">
              <div className="grid grid-cols-2 md:grid-cols-5 gap-6">
                {[
                  { name: 'Ziad Behairy', role: 'Product Lead', color: 'teal' },
                  { name: 'Ahmed Amin', role: 'AI Architect', color: 'blue' },
                  { name: 'Nourhan M.', role: 'Nav Lead', color: 'purple' },
                  { name: 'Mohamed M.', role: 'Hardware Lead', color: 'orange' },
                  { name: 'Omar Awad', role: 'Data Lead', color: 'indigo' }
                ].map((member, i) => (
                  <div key={i} className="bg-slate-50 p-6 rounded-2xl border border-slate-100 hover:border-teal-200 hover:shadow-md transition-all text-center group">
                    <div className={`w-20 h-20 bg-${member.color}-100 rounded-full mx-auto mb-4 overflow-hidden flex items-center justify-center text-${member.color}-600 font-bold text-xl group-hover:scale-110 transition-transform`}>
                      {member.name.charAt(0)}
                    </div>
                    <h4 className="font-bold text-slate-800 mb-1">{member.name}</h4>
                    <p className="text-xs text-slate-500 uppercase tracking-wide">{member.role}</p>
                  </div>
                ))}
              </div>
              <div className="mt-8 bg-yellow-50 border border-yellow-200 p-4 rounded-xl text-center text-yellow-800 font-medium flex items-center justify-center gap-2">
                <Sparkles size={18} /> VEX U World Championship Winners
              </div>
            </Card>
          </div>
        )}
      </div>
    </div>
  );
};

// 4. Role Dashboards (Patient, Caregiver) - Enhanced

const PatientDashboard = () => {
  const { apiKey } = useContext(AuthContext);
  const [command, setCommand] = useState('');
  const [aiResponse, setAiResponse] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const handleVoiceCommand = async () => {
    if (!apiKey) {
      setAiResponse("⚠️ API Key missing. Please go to Config in sidebar.");
      return;
    }
    setLoading(true);
    setAiResponse(null);
    
    const prompt = `You are the AI brain of the Rafeeq Wheelchair. 
    The user said: "${command}". 
    Classify this intent into one of: [NAVIGATE_KITCHEN, NAVIGATE_BEDROOM, STOP, SOS, QUERY_STATUS, UNKNOWN].
    Return a JSON object with { "intent": "string", "reply_arabic": "string (Egyptian Dialect)" }. 
    Only return valid JSON.`;

    const result = await callGemini(prompt, apiKey);
    
    try {
      const cleanJson = result.replace(/```json|```/g, '').trim();
      const parsed = JSON.parse(cleanJson);
      setAiResponse(`${parsed.intent} — ${parsed.reply_arabic}`);
    } catch (e) {
      setAiResponse("System: Command processed (Simulation Mode)");
    }
    setLoading(false);
  };

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 max-w-4xl mx-auto">
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-3xl font-bold text-slate-800">Marhaba, Ahmed</h2>
          <p className="text-slate-500">Ready for your command.</p>
        </div>
        <Badge status="normal" />
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
        <Card title="Emergency SOS" className="border-red-100 bg-gradient-to-br from-red-50 to-white hover:shadow-lg transition-shadow">
          <div className="text-center py-10">
            <button className="w-40 h-40 rounded-full bg-red-600 shadow-[0_0_40px_rgba(220,38,38,0.4)] text-white font-black text-2xl animate-pulse hover:bg-red-700 active:scale-95 transition-all flex flex-col items-center justify-center mx-auto">
              <AlertTriangle size={48} className="mb-2" />
              SOS
            </button>
            <p className="text-red-700 mt-6 font-medium bg-red-100 inline-block px-4 py-1 rounded-full text-sm">Hold 3s to Alert</p>
          </div>
        </Card>

        {/* AI Voice Command Section */}
        <Card title="AI Voice Command" className="border-purple-100 bg-gradient-to-br from-purple-50 to-white hover:shadow-lg transition-shadow">
          <div className="space-y-6 py-4">
            <div className="relative">
              <input 
                type="text" 
                value={command}
                onChange={(e) => setCommand(e.target.value)}
                placeholder="Type 'Waddini el matbakh'..." 
                className="w-full pl-12 p-4 rounded-xl border border-slate-200 focus:ring-4 focus:ring-purple-100 focus:border-purple-500 outline-none text-lg shadow-sm"
              />
              <Mic className="absolute left-4 top-4 text-purple-400" size={24} />
            </div>
            
            <Button 
              variant="ai" 
              className="w-full py-4 text-lg rounded-xl" 
              onClick={handleVoiceCommand}
              disabled={loading || !command}
            >
              {loading ? <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <><Sparkles size={20} /> Process Command</>}
            </Button>

            {aiResponse && (
              <div className="bg-white p-4 rounded-xl border border-purple-100 text-slate-700 flex items-start gap-3 shadow-sm animate-in fade-in slide-in-from-top-2">
                <div className="p-2 bg-purple-100 rounded-lg"><MessageSquare size={20} className="text-purple-600" /></div>
                <p className="font-medium mt-1">{aiResponse}</p>
              </div>
            )}
          </div>
        </Card>
      </div>
    </div>
  );
};

const CaregiverDashboard = () => {
  const { apiKey } = useContext(AuthContext);
  const [activeTab, setActiveTab] = useState('vitals');
  const [aiAnalysis, setAiAnalysis] = useState<string | null>(null);
  const [analyzing, setAnalyzing] = useState(false);
  const [vitals, setVitals] = useState({ hr: 78, spo2: 99, temp: 37.0 });

  useEffect(() => {
    const timer = setInterval(() => {
      setVitals(prev => ({
        hr: 75 + Math.floor(Math.random() * 10),
        spo2: 97 + Math.floor(Math.random() * 3),
        temp: +(36.5 + Math.random()).toFixed(1)
      }));
    }, 3000);
    return () => clearInterval(timer);
  }, []);

  const analyzeVitals = async () => {
    if (!apiKey) {
      setAiAnalysis("⚠️ API Key missing. Please check Settings.");
      return;
    }
    setAnalyzing(true);
    setAiAnalysis(null);

    const prompt = `Act as a medical AI assistant. 
    Current Vitals: Heart Rate ${vitals.hr} bpm, SpO2 ${vitals.spo2}%, Temp ${vitals.temp}°C.
    Provide a 1-sentence health assessment. Is this normal? Start with 'Assessment:'.`;

    const result = await callGemini(prompt, apiKey);
    setAiAnalysis(result || "Could not analyze data.");
    setAnalyzing(false);
  };
  
  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 max-w-5xl mx-auto">
      <header className="flex justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
        <div className="flex items-center gap-6">
          <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center text-slate-600 font-bold text-xl">ZB</div>
          <div>
            <h2 className="text-2xl font-bold text-slate-800">Ziad Behairy</h2>
            <p className="text-sm text-slate-500 flex items-center gap-2 mt-1">
              <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Online • Device: W-105
            </p>
          </div>
        </div>
        <div className="flex bg-slate-100 p-1 rounded-xl">
          <button onClick={() => setActiveTab('vitals')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'vitals' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Vitals</button>
          <button onClick={() => setActiveTab('map')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'map' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Location</button>
        </div>
      </header>

      {activeTab === 'vitals' && (
        <div className="space-y-6">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
            <Card className="flex flex-col items-center justify-center p-6 hover:shadow-lg transition-shadow border-t-4 border-t-rose-500">
              <Heart size={32} className="text-rose-500 mb-2" />
              <p className="text-slate-500 font-medium">Heart Rate</p>
              <p className="text-3xl font-black text-slate-800">{vitals.hr} <span className="text-sm font-normal text-slate-400">BPM</span></p>
            </Card>
            <Card className="flex flex-col items-center justify-center p-6 hover:shadow-lg transition-shadow border-t-4 border-t-blue-500">
              <Activity size={32} className="text-blue-500 mb-2" />
              <p className="text-slate-500 font-medium">SpO2</p>
              <p className="text-3xl font-black text-slate-800">{vitals.spo2}<span className="text-sm font-normal text-slate-400">%</span></p>
            </Card>
            <Card className="flex flex-col items-center justify-center p-6 hover:shadow-lg transition-shadow border-t-4 border-t-orange-500">
              <Thermometer size={32} className="text-orange-500 mb-2" />
              <p className="text-slate-500 font-medium">Temp</p>
              <p className="text-3xl font-black text-slate-800">{vitals.temp}<span className="text-sm font-normal text-slate-400">°C</span></p>
            </Card>
            <Card className="flex flex-col items-center justify-center p-6 hover:shadow-lg transition-shadow border-t-4 border-t-green-500 bg-green-50">
              <CheckCircle size={32} className="text-green-600 mb-2" />
              <p className="text-green-700 font-medium">System Status</p>
              <p className="text-2xl font-black text-green-800">Stable</p>
            </Card>
          </div>

          {/* AI Insight Section */}
          <div className="bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl p-6 text-white shadow-xl flex items-center justify-between border border-slate-700">
            <div className="flex-1 pr-4">
              <h3 className="font-bold flex items-center gap-2 mb-2 text-lg"><Sparkles size={20} className="text-yellow-400" /> AI Health Insight</h3>
              <p className="text-slate-300 leading-relaxed">
                {analyzing ? "Analyzing vitals pattern..." : aiAnalysis || "Click analyze to get a real-time AI assessment of the patient's current vitals."}
              </p>
            </div>
            <Button variant="ai" onClick={analyzeVitals} disabled={analyzing} className="ml-4 h-fit whitespace-nowrap">
              {analyzing ? "Thinking..." : "Analyze Vitals"}
            </Button>
          </div>
        </div>
      )}

      {activeTab === 'map' && (
        <Card title="Live Location Tracking" className="h-[500px] bg-slate-100 flex items-center justify-center relative overflow-hidden group">
          <div className="absolute inset-0 bg-[url('https://api.mapbox.com/styles/v1/mapbox/light-v10/static/31.2357,30.0444,14,0/1000x600?access_token=pk.xxx')] bg-cover bg-center opacity-60 group-hover:opacity-100 transition-opacity duration-700"></div>
          <div className="z-10 text-center transform group-hover:scale-110 transition-transform duration-500">
            <div className="w-20 h-20 bg-teal-600 rounded-full border-4 border-white shadow-2xl mx-auto mb-4 flex items-center justify-center animate-bounce">
              <Users className="text-white" size={32} />
            </div>
            <div className="bg-white/90 backdrop-blur px-6 py-3 rounded-xl shadow-lg">
              <p className="font-bold text-slate-800 text-lg">Ziad Behairy</p>
              <p className="text-sm text-slate-600">Smart Village, Giza • Just now</p>
            </div>
          </div>
        </Card>
      )}
    </div>
  );
};

// --- Main App Logic ---

const App = () => {
  const [user, setUser] = useState<User | null>(null);
  const [apiKey, setApiKey] = useState('');

  const login = (role: UserRole) => {
    setUser({ 
      uid: '123', 
      name: role === 'patient' ? 'Ahmed Amin' : role === 'doctor' ? 'Dr. Sarah' : role === 'guest' ? 'Project Judge' : 'Ziad Behairy', 
      role: role, 
      email: `${role}@rafeeq.com` 
    });
  };

  const logout = () => setUser(null);

  return (
    <AuthContext.Provider value={{ user, login, logout, apiKey, setApiKey }}>
      {!user ? (
        <LoginScreen />
      ) : (
        <DashboardLayout role={user.role}>
          {user.role === 'guest' && <ProjectInfoDashboard />}
          {user.role === 'patient' && <PatientDashboard />}
          {user.role === 'caregiver' && <CaregiverDashboard />}
          {/* Add other dashboards as needed */}
        </DashboardLayout>
      )}
    </AuthContext.Provider>
  );
};

export default App;
